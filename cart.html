<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Kavak Culture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'sans': ['Inter', 'sans-serif'] },
                    colors: {
                        'brand-green': '#4A6B4C',
                        'brand-light-green': '#89A88A',
                        'brand-off-white': '#F8F7F4',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-brand-off-white">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <img src="Gayatrilogo.jpg" alt="Kavak Culture Logo" class="h-12 w-auto">
            </a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-brand-green transition">Home</a>
                 <!-- Add Login/Logout Status -->
                 <span id="auth-status" class="text-gray-600"></span>
            </div>
             <!-- Mobile Menu Button (Optional, if needed) -->
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8">
        <a href="index.html" class="mb-8 inline-block text-brand-green hover:text-brand-light-green transition font-semibold">
            &larr; Back to Shop
        </a>
        <h1 class="text-3xl font-bold text-gray-800 mb-8">Your Shopping Cart</h1>

        <div class="grid md:grid-cols-3 gap-8">
            <!-- Cart Items -->
            <div class="md:col-span-2">
                <div id="cart-items" class="space-y-4">
                    <!-- Cart items will be dynamically inserted here -->
                     <p id="cart-empty-message" class="text-gray-500 text-center py-8 hidden">Your cart is empty</p>
                </div>
            </div>

            <!-- Cart Summary -->
            <div class="md:col-span-1">
                <div class="bg-white p-6 rounded-lg shadow-md sticky top-28">
                    <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between">
                            <span>Subtotal</span>
                            <span id="subtotal">₹0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Shipping</span>
                            <span id="shipping">₹0.00</span> <!-- Default to 0, update in JS -->
                        </div>
                        <div class="border-t pt-2 mt-2">
                            <div class="flex justify-between font-bold text-lg"> <!-- Made total bold and larger -->
                                <span>Total</span>
                                <span id="total">₹0.00</span>
                            </div>
                        </div>
                    </div>
                    <!-- Auth Check Section -->
                    <div id="auth-check-loading" class="text-center text-gray-500 my-4">Checking login status...</div>
                    <div id="checkout-actions" class="hidden"> <!-- Hide actions until auth check is done -->
                        <button id="checkout-button" class="w-full bg-brand-green text-white py-3 rounded-md hover:bg-brand-light-green transition disabled:opacity-50 disabled:cursor-not-allowed">
                            Proceed to Checkout
                        </button>
                        <p id="login-prompt" class="text-center text-sm text-red-500 mt-2 hidden">
                            Please <a href="login.html" class="underline font-semibold">login or sign up</a> to proceed.
                        </p>
                        <button id="logout-button" class="w-full text-center text-red-500 hover:underline mt-4 text-sm hidden">
                            Log Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // --- SUPABASE CLIENT INITIALIZATION ---
        const SUPABASE_URL = 'https://rdgibagwcenwthrcsllp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkZ2liYWd3Y2Vud3RocmNzbGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMDE5MTIsImV4cCI6MjA3NjY3NzkxMn0.d5CthwkuclqKk1z7gjwsgaP0P53q2dFya5k5fRNAxAY';

        if (!window.supabase) { console.error("Supabase not loaded"); }
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ELEMENTS ---
        const cartContainer = document.getElementById('cart-items');
        const cartEmptyMessage = document.getElementById('cart-empty-message');
        const subtotalEl = document.getElementById('subtotal');
        const shippingEl = document.getElementById('shipping');
        const totalEl = document.getElementById('total');
        const checkoutButton = document.getElementById('checkout-button');
        const loginPrompt = document.getElementById('login-prompt');
        const authCheckLoading = document.getElementById('auth-check-loading');
        const checkoutActions = document.getElementById('checkout-actions');
        const authStatusEl = document.getElementById('auth-status');
        const logoutButton = document.getElementById('logout-button');

        // --- CART DATA --- (Loaded from localStorage)
        let cart = JSON.parse(localStorage.getItem('kavakCart')) || [];

        // --- FUNCTIONS ---
        function updateCartDisplay() {
            cartContainer.innerHTML = ''; // Clear previous items

            if (cart.length === 0) {
                cartEmptyMessage.classList.remove('hidden');
            } else {
                 cartEmptyMessage.classList.add('hidden');
                cart.forEach((item, index) => {
                    const price = item.price || item.Price || 0; // Handle potential case mismatch
                    const name = item.name || item.Name || 'Unnamed Product';
                    const image = item.image || '';

                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center gap-4 bg-white p-4 rounded-lg shadow-sm border'; // Added border
                    itemElement.innerHTML = `
                        <img src="${image}" alt="${name}" class="w-20 h-20 md:w-24 md:h-24 object-cover rounded"
                             onerror="this.onerror=null; this.src='https://placehold.co/100x100/EAF0E5/4A6B4C?text=${encodeURIComponent(name)}';">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg">${name}</h3>
                            <p class="text-gray-600">₹${Number(price).toFixed(2)}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <button onclick="updateQuantity(${index}, -1)" class="px-2 py-1 border rounded hover:bg-gray-100 text-lg leading-none">-</button>
                                <span class="font-medium w-8 text-center">${item.quantity}</span>
                                <button onclick="updateQuantity(${index}, 1)" class="px-2 py-1 border rounded hover:bg-gray-100 text-lg leading-none">+</button>
                            </div>
                        </div>
                        <div class="text-right">
                             <p class="font-semibold mb-2">₹${(Number(price) * item.quantity).toFixed(2)}</p>
                             <button onclick="removeItem(${index})" class="text-red-500 hover:text-red-700 ml-auto" title="Remove item">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                    cartContainer.appendChild(itemElement);
                });
            }
            updateTotals();
            checkAuthState(); // Re-check auth state in case cart becomes empty/non-empty
        }

        function updateQuantity(index, change) {
            if (cart[index]) {
                cart[index].quantity += change;
                if (cart[index].quantity <= 0) {
                    removeItem(index); // Remove if quantity drops to 0 or below
                } else {
                    localStorage.setItem('kavakCart', JSON.stringify(cart));
                    updateCartDisplay();
                }
            }
        }

        function removeItem(index) {
            cart.splice(index, 1);
            localStorage.setItem('kavakCart', JSON.stringify(cart));
            updateCartDisplay();
        }

        function updateTotals() {
            const subtotal = cart.reduce((total, item) => {
                 const price = item.price || item.Price || 0;
                 return total + (Number(price) * item.quantity);
             }, 0);
            const shipping = cart.length > 0 ? 50 : 0; // Example fixed shipping
            const total = subtotal + shipping;

            subtotalEl.textContent = `₹${subtotal.toFixed(2)}`;
            shippingEl.textContent = `₹${shipping.toFixed(2)}`;
            totalEl.textContent = `₹${total.toFixed(2)}`;
        }

        async function checkAuthState() {
            authCheckLoading.style.display = 'block';
            checkoutActions.classList.add('hidden');
            loginPrompt.classList.add('hidden');
            checkoutButton.disabled = true;
            logoutButton.classList.add('hidden');
            authStatusEl.textContent = ''; // Clear previous status


            const { data: { session }, error } = await supabaseClient.auth.getSession();

            authCheckLoading.style.display = 'none';
            checkoutActions.classList.remove('hidden');

            if (error) {
                console.error("Error checking auth status:", error);
                // Assume logged out on error, prompt login if cart has items
                 if (cart.length > 0) loginPrompt.classList.remove('hidden');
                 authStatusEl.innerHTML = `<a href="login.html" class="text-brand-green font-semibold hover:underline">Login</a>`;
            } else if (session?.user) {
                // User is logged in
                console.log("User logged in:", session.user);
                 authStatusEl.textContent = `Logged in as ${session.user.email}`;
                 logoutButton.classList.remove('hidden'); // Show logout button

                 if (cart.length > 0) {
                     checkoutButton.disabled = false; // Enable checkout only if cart has items
                 } else {
                      checkoutButton.disabled = true; // Disable if cart is empty
                 }
            } else {
                // User is logged out
                console.log("User logged out");
                authStatusEl.innerHTML = `<a href="login.html" class="text-brand-green font-semibold hover:underline">Login</a>`;
                if (cart.length > 0) {
                    loginPrompt.classList.remove('hidden'); // Show login prompt only if cart has items
                }
            }
        }

        async function handleLogout() {
             const { error } = await supabaseClient.auth.signOut();
             if (error) {
                 console.error("Logout error:", error);
                 alert("Error logging out. Please try again.");
             } else {
                 console.log("Logged out successfully");
                 checkAuthState(); // Re-check auth state to update UI
             }
        }


        // --- EVENT LISTENERS ---
        checkoutButton.addEventListener('click', () => {
             // Re-verify login before proceeding (optional but good practice)
             supabaseClient.auth.getSession().then(({ data: { session } }) => {
                 if (session?.user && cart.length > 0) {
                     window.location.href = 'payment.html';
                 } else if (cart.length === 0) {
                     alert("Your cart is empty.");
                 }
                 else {
                     loginPrompt.classList.remove('hidden');
                     alert("Please log in to proceed.");
                 }
             });
        });

        logoutButton.addEventListener('click', handleLogout);

        // --- INITIALIZATION ---
        updateCartDisplay(); // Initial display based on localStorage
        // checkAuthState(); // Check login status on page load - Called within updateCartDisplay now


    </script>
</body>
</html>
